name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìë™í™”

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'playwright.config.ts'
      - 'jest.config.js'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'tests/**'
      - 'package.json'
      - 'playwright.config.ts'
      - 'jest.config.js'
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œì— ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - cron: '0 2 * * *'

jobs:
  performance-test:
    name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        browser: [chromium, firefox, webkit]
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: Playwright ë¸Œë¼ìš°ì € ì„¤ì¹˜
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: ë¹Œë“œ
        run: npm run build
        
      - name: Jest ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npm test -- --coverage --watchAll=false
        
      - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          npm run test:e2e -- --project=performance
          npm run test:e2e -- --project=accessibility
          
      - name: ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìˆ˜ì§‘
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results-${{ matrix.browser }}-${{ matrix.node-version }}
          path: |
            test-results/
            playwright-report/
            coverage/
            
      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
        if: always()
        run: |
          echo "## ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "### ë¸Œë¼ìš°ì €: ${{ matrix.browser }}" >> $GITHUB_STEP_SUMMARY
          echo "### Node.js ë²„ì „: ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "test-results/results.json" ]; then
            echo "### í…ŒìŠ¤íŠ¸ í†µê³„" >> $GITHUB_STEP_SUMMARY
            cat test-results/results.json | jq -r '.stats | "**í†µê³¼:** \(.passed) | **ì‹¤íŒ¨:** \(.failed) | **ê±´ë„ˆëœ€:** \(.skipped)"' >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "### í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€" >> $GITHUB_STEP_SUMMARY
            cat coverage/coverage-summary.json | jq -r '.total | "**ë¼ì¸:** \(.lines.pct)% | **í•¨ìˆ˜:** \(.functions.pct)% | **ë¶„ê¸°:** \(.branches.pct)%"' >> $GITHUB_STEP_SUMMARY
          fi

  performance-benchmark:
    name: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
    runs-on: ubuntu-latest
    needs: performance-test
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰
        run: |
          npm run test:performance
          
      - name: ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-benchmark-results
          path: test-results/performance/
          
      - name: ì„±ëŠ¥ ì„ê³„ê°’ ê²€ì¦
        run: |
          # ì„±ëŠ¥ ì„ê³„ê°’ í™•ì¸
          FPS_THRESHOLD=30
          MEMORY_THRESHOLD=100
          FRAME_TIME_THRESHOLD=33
          
          echo "## ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "### ì„±ëŠ¥ ì„ê³„ê°’ ê²€ì¦" >> $GITHUB_STEP_SUMMARY
          
          # FPS ê²€ì¦
          if [ -f "test-results/performance/fps.json" ]; then
            AVG_FPS=$(cat test-results/performance/fps.json | jq -r '.average')
            if (( $(echo "$AVG_FPS >= $FPS_THRESHOLD" | bc -l) )); then
              echo "âœ… **FPS:** $AVG_FPS (ì„ê³„ê°’: $FPS_THRESHOLD)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **FPS:** $AVG_FPS (ì„ê³„ê°’: $FPS_THRESHOLD) - ì„±ëŠ¥ ì €í•˜ ê°ì§€!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ê²€ì¦
          if [ -f "test-results/performance/memory.json" ]; then
            AVG_MEMORY=$(cat test-results/performance/memory.json | jq -r '.average')
            if (( $(echo "$AVG_MEMORY <= $MEMORY_THRESHOLD" | bc -l) )); then
              echo "âœ… **ë©”ëª¨ë¦¬:** $AVG_MEMORY MB (ì„ê³„ê°’: $MEMORY_THRESHOLD MB)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **ë©”ëª¨ë¦¬:** $AVG_MEMORY MB (ì„ê³„ê°’: $MEMORY_THRESHOLD MB) - ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì´ˆê³¼!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi
          
          # í”„ë ˆì„ íƒ€ì„ ê²€ì¦
          if [ -f "test-results/performance/frame-time.json" ]; then
            AVG_FRAME_TIME=$(cat test-results/performance/frame-time.json | jq -r '.average')
            if (( $(echo "$AVG_FRAME_TIME <= $FRAME_TIME_THRESHOLD" | bc -l) )); then
              echo "âœ… **í”„ë ˆì„ íƒ€ì„:** $AVG_FRAME_TIME ms (ì„ê³„ê°’: $FRAME_TIME_THRESHOLD ms)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **í”„ë ˆì„ íƒ€ì„:** $AVG_FRAME_TIME ms (ì„ê³„ê°’: $FRAME_TIME_THRESHOLD ms) - ë Œë”ë§ ì§€ì—° ê°ì§€!" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          fi

  performance-report:
    name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
    runs-on: ubuntu-latest
    needs: [performance-test, performance-benchmark]
    if: always()
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci
        
      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          npm run generate:performance-report
          
      - name: ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: |
            performance-report/
            test-results/
            
      - name: ì„±ëŠ¥ ë¦¬í¬íŠ¸ ìš”ì•½
        run: |
          echo "## ğŸ“Š ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€" >> $GITHUB_STEP_SUMMARY
          if [ -f "coverage/coverage-summary.json" ]; then
            cat coverage/coverage-summary.json | jq -r '.total | "**ì „ì²´ ì»¤ë²„ë¦¬ì§€:** \(.lines.pct)%"' >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬" >> $GITHUB_STEP_SUMMARY
          echo "**FPS:** 30+ (ê¶Œì¥: 60+)" >> $GITHUB_STEP_SUMMARY
          echo "**ë©”ëª¨ë¦¬:** 100MB ì´í•˜" >> $GITHUB_STEP_SUMMARY
          echo "**í”„ë ˆì„ íƒ€ì„:** 33ms ì´í•˜" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ì•„í‹°íŒ©íŠ¸" >> $GITHUB_STEP_SUMMARY
          echo "- ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- ë²¤ì¹˜ë§ˆí¬ ë°ì´í„°" >> $GITHUB_STEP_SUMMARY
          echo "- ìƒì„¸ ë¦¬í¬íŠ¸" >> $GITHUB_STEP_SUMMARY

  performance-alert:
    name: ì„±ëŠ¥ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [performance-test, performance-benchmark]
    if: failure()
    
    steps:
      - name: ì„±ëŠ¥ ì €í•˜ ì•Œë¦¼
        run: |
          echo "## ğŸš¨ ì„±ëŠ¥ ì €í•˜ ê°ì§€!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‰ ì„±ëŠ¥ ë¬¸ì œ" >> $GITHUB_STEP_SUMMARY
          echo "- í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ë˜ëŠ” ì„±ëŠ¥ ì„ê³„ê°’ ë¯¸ë‹¬" >> $GITHUB_STEP_SUMMARY
          echo "- ì¦‰ì‹œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”§ ê¶Œì¥ ì¡°ì¹˜" >> $GITHUB_STEP_SUMMARY
          echo "1. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ê²€í† " >> $GITHUB_STEP_SUMMARY
          echo "2. ì„±ëŠ¥ ë³‘ëª© ì§€ì  ë¶„ì„" >> $GITHUB_STEP_SUMMARY
          echo "3. ìµœì í™” ì‘ì—… ìˆ˜í–‰" >> $GITHUB_STEP_SUMMARY
          echo "4. ì¬í…ŒìŠ¤íŠ¸ ì‹¤í–‰" >> $GITHUB_STEP_SUMMARY
