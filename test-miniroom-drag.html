<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ë‹ˆë£¸ ë“œë˜ê·¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 20px;
            background: #2a2a2a;
            text-align: center;
        }
        .miniroom-container {
            flex: 1;
            position: relative;
        }
        .test-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ë¯¸ë‹ˆë£¸ ë“œë˜ê·¸ í…ŒìŠ¤íŠ¸</h1>
            <p>ë§ˆìš°ìŠ¤ë‚˜ í„°ì¹˜ë¡œ ë“œë˜ê·¸í•˜ì—¬ ì¹´ë©”ë¼ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”</p>
        </div>
        <div class="miniroom-container">
            <div class="test-info">
                <div>í…ŒìŠ¤íŠ¸ ìƒíƒœ: <span id="test-status">ì¤€ë¹„ ì¤‘...</span></div>
                <div>ë“œë˜ê·¸ íšŸìˆ˜: <span id="drag-count">0</span></div>
                <div>ë§ˆì§€ë§‰ ì´ë²¤íŠ¸: <span id="last-event">ì—†ìŒ</span></div>
            </div>
            <div id="miniroom-root"></div>
        </div>
    </div>

    <script type="module">
        import React from 'https://esm.sh/react@18';
        import ReactDOM from 'https://esm.sh/react-dom@18';
        import { Canvas } from 'https://esm.sh/@react-three/fiber@8.15.19';
        import { CameraControls, PresentationControls, TransformControls, Html } from 'https://esm.sh/@react-three/drei@9.88.13';
        import * as THREE from 'https://esm.sh/three@0.158.0';
        import { useGesture } from 'https://esm.sh/@use-gesture/react@10.3.0';
        import { create } from 'https://esm.sh/zustand@4.4.7';

        // ìƒíƒœ ê´€ë¦¬
        let dragCount = 0;
        let lastEvent = 'ì—†ìŒ';

        function updateTestInfo() {
            document.getElementById('test-status').textContent = 'ì‹¤í–‰ ì¤‘';
            document.getElementById('drag-count').textContent = dragCount.toString();
            document.getElementById('last-event').textContent = lastEvent;
        }

        // ì¹´ë©”ë¼ ìƒíƒœ ê´€ë¦¬
        const useCam = create((set) => ({
            zoom: 0,
            truck: [0, 0],
            addTruck: (dx, dy) => set((s) => ({ truck: [s.truck[0] + dx, s.truck[1] + dy] })),
            addZoom: (dz) => set((s) => ({ zoom: Math.min(Math.max(s.zoom + dz, -5), 5) })),
            reset: () => set({ zoom: 0, truck: [0, 0] }),
        }));

        // ë°”ë‹¥
        function Floor() {
            const grid = React.useMemo(() => new THREE.GridHelper(20, 20, 0x888888, 0x444444), []);
            return React.createElement('primitive', { object: grid, position: [0, -0.01, 0] });
        }

        // ì¡°ëª…
        function LightRig() {
            return React.createElement(React.Fragment, null,
                React.createElement('ambientLight', { intensity: 0.5 }),
                React.createElement('directionalLight', { position: [5, 8, 5], intensity: 0.9, castShadow: true })
            );
        }

        // íšŒì „í•˜ëŠ” ë°•ìŠ¤
        function CuteBox(props) {
            const ref = React.useRef();
            React.useEffect(() => {
                let animationId;
                const animate = () => {
                    if (ref.current) {
                        ref.current.rotation.y += 0.01;
                    }
                    animationId = requestAnimationFrame(animate);
                };
                animate();
                return () => cancelAnimationFrame(animationId);
            }, []);
            
            return React.createElement('mesh', { ref, castShadow: true, receiveShadow: true, ...props },
                React.createElement('boxGeometry', { args: [1, 1, 1] }),
                React.createElement('meshStandardMaterial', { color: "#7ccfff", metalness: 0.1, roughness: 0.6 })
            );
        }

        // ì¹´ë©”ë¼ ì»¨íŠ¸ë¡¤ëŸ¬
        function CameraController({ controls }) {
            React.useEffect(() => {
                let animationId;
                const animate = () => {
                    const api = controls.current;
                    if (api) {
                        const { truck, zoom } = useCam.getState();
                        if (truck[0] !== 0 || truck[1] !== 0) {
                            api.truck(truck[0], truck[1], true);
                            useCam.setState({ truck: [0, 0] });
                        }
                        if (zoom !== 0) {
                            api.dolly(zoom, true);
                            useCam.setState({ zoom: 0 });
                        }
                    }
                    animationId = requestAnimationFrame(animate);
                };
                animate();
                return () => cancelAnimationFrame(animationId);
            }, [controls]);
            return null;
        }

        // ì œìŠ¤ì²˜ ì˜¤ë²„ë ˆì´
        function GestureOverlay({ controls }) {
            const ref = React.useRef();
            const addTruck = useCam((s) => s.addTruck);
            const addZoom = useCam((s) => s.addZoom);

            useGesture(
                {
                    onDrag: ({ delta: [dx, dy], event, touches }) => {
                        event.preventDefault();
                        event.stopPropagation();
                        const speed = touches > 0 ? 0.0025 : 0.002;
                        addTruck(-dx * speed, dy * speed);
                        dragCount++;
                        lastEvent = `ë“œë˜ê·¸: dx=${dx.toFixed(2)}, dy=${dy.toFixed(2)}`;
                        updateTestInfo();
                        console.log('ğŸ–±ï¸ ë“œë˜ê·¸ ì´ë²¤íŠ¸:', { dx, dy, touches, speed });
                    },
                    onPinch: ({ delta: [d], event }) => {
                        event.preventDefault();
                        event.stopPropagation();
                        addZoom(-d * 0.005);
                        lastEvent = `í•€ì¹˜: delta=${d.toFixed(2)}`;
                        updateTestInfo();
                        console.log('ğŸ¤ í•€ì¹˜ ì´ë²¤íŠ¸:', { delta: d });
                    },
                    onWheel: ({ delta: [_, dy], event }) => {
                        event.preventDefault();
                        event.stopPropagation();
                        addZoom(dy * 0.0015);
                        lastEvent = `íœ : dy=${dy.toFixed(2)}`;
                        updateTestInfo();
                        console.log('ğŸ¡ íœ  ì´ë²¤íŠ¸:', { dy });
                    },
                },
                { 
                    target: ref, 
                    eventOptions: { passive: false },
                    drag: { threshold: 1 },
                    pinch: { threshold: 0.05 }
                }
            );

            return React.createElement('div', {
                ref,
                style: { 
                    position: "absolute", 
                    inset: 0, 
                    touchAction: "none",
                    zIndex: 50,
                    pointerEvents: "auto",
                    backgroundColor: "rgba(255, 0, 0, 0.05)" // ë””ë²„ê¹…ìš©
                }
            });
        }

        // ë©”ì¸ ë¯¸ë‹ˆë£¸ ì»´í¬ë„ŒíŠ¸
        function MiniRoom() {
            const camRef = React.useRef();

            return React.createElement('div', { 
                style: { width: "100%", height: "100%", position: "relative" }
            },
                // UI ì»¨íŠ¸ë¡¤
                React.createElement('div', {
                    style: {
                        position: "absolute",
                        top: 12,
                        left: 12,
                        zIndex: 60,
                        display: "flex",
                        gap: 8,
                        alignItems: "center",
                        padding: "8px 10px",
                        borderRadius: 12,
                        background: "rgba(0,0,0,0.45)",
                        backdropFilter: "blur(6px)",
                        color: "white",
                        userSelect: "none",
                        pointerEvents: "auto",
                    }
                },
                    React.createElement('button', {
                        onClick: () => useCam.getState().reset(),
                        style: {
                            padding: "6px 10px",
                            borderRadius: 10,
                            border: 0,
                            background: "#374151",
                            color: "white",
                            fontSize: 14,
                        }
                    }, "Reset View"),
                    React.createElement('span', { style: { opacity: 0.8, fontSize: 12 } }, "â€¢ Drag = Pan â€¢ Pinch/Wheel = Zoom")
                ),

                // Canvas
                React.createElement(Canvas, {
                    shadows: true,
                    camera: { position: [4, 3, 6], fov: 45 },
                    gl: { antialias: true },
                    style: { touchAction: "none" },
                    onCreated: ({ gl }) => {
                        gl.setClearColor(0x0e1116);
                        gl.outputColorSpace = THREE.SRGBColorSpace;
                    }
                },
                    React.createElement(LightRig),
                    React.createElement(Floor),
                    React.createElement(PresentationControls, { global: true, polar: [-0.3, 0.3], azimuth: [-0.6, 0.6] },
                        React.createElement(CuteBox, { position: [0, 0.5, 0] })
                    ),
                    React.createElement(CameraControls, { 
                        ref: camRef, 
                        makeDefault: true, 
                        dollyToCursor: true, 
                        minDistance: 2, 
                        maxDistance: 20
                    }),
                    React.createElement(CameraController, { controls: camRef }),
                    React.createElement(Html, { position: [0, 1.6, 0], center: true },
                        React.createElement('div', {
                            style: {
                                padding: "4px 8px",
                                borderRadius: 8,
                                background: "rgba(255,255,255,0.08)",
                                border: "1px solid rgba(255,255,255,0.15)",
                                color: "#e5e7eb",
                                fontSize: 12,
                                whiteSpace: "nowrap",
                                userSelect: "none",
                                pointerEvents: "none",
                            }
                        }, "Touch: pinch = zoom, drag = pan")
                    )
                ),

                // ì œìŠ¤ì²˜ ì˜¤ë²„ë ˆì´
                React.createElement(GestureOverlay, { controls: camRef })
            );
        }

        // ì•± ë Œë”ë§
        const root = ReactDOM.createRoot(document.getElementById('miniroom-root'));
        root.render(React.createElement(MiniRoom));

        // ì´ˆê¸° ìƒíƒœ ì—…ë°ì´íŠ¸
        updateTestInfo();
    </script>
</body>
</html>
